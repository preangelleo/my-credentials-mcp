import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { 
	Props, 
	createErrorResponse,
	createSuccessResponse
} from "../types";
import { z } from "zod";

// Schema definitions for product feedback tools
const SubmitSuggestionSchema = z.object({
	product_name: z.string().min(1, "Product name is required"),
	title: z.string().min(1, "Title is required"),
	brief: z.string().optional(),
	detailed_suggestion: z.string().optional(),
	priority: z.enum(['low', 'medium', 'high', 'critical']).default('medium'),
	suggester_signature: z.string().optional()
});

const GetSuggestionsSchema = z.object({
	product_name: z.string().optional(),
	status: z.enum(['submitted', 'under_review', 'accepted', 'in_progress', 'completed', 'rejected']).optional(),
	priority: z.enum(['low', 'medium', 'high', 'critical']).optional(),
	limit: z.union([z.number(), z.string().transform(Number)]).pipe(z.number().min(1).max(100)).default(10)
});

const UpdateSuggestionStatusSchema = z.object({
	id: z.union([z.number(), z.string().transform(Number)]).pipe(z.number().min(1)),
	status: z.enum(['submitted', 'under_review', 'accepted', 'in_progress', 'completed', 'rejected']),
	developer_notes: z.string().optional(),
	priority: z.enum(['low', 'medium', 'high', 'critical']).optional()
});

// Use the shared HTTP API utility from http-api-tools 
// This eliminates the duplicate implementation and API conflicts
import { callHttpApi } from "./http-api-tools";

const PRIVILEGED_USERS = new Set<string>([
	'preangelleo'   // Only authorized user for status updates
]);

export function registerProductFeedbackTools(server: McpServer, env: Env, props: Props) {
	
	// Tool 1: Submit Product Suggestion - Available to all authenticated users
	server.tool(
		"submitProductSuggestion",
		`üìù PRODUCT IMPROVEMENT SUGGESTIONS
		
Submit bug reports, feature requests, and improvement suggestions for MCP server products. Available to all authenticated users.

üìä REQUIRED PARAMETERS:
‚Ä¢ product_name: MCP server name (e.g., "My Credentials MCP Server", "Ghost Blog Management MCP Server")  
‚Ä¢ title: Clear, concise issue/feature title (e.g., "Fix HTTP 500 error in API", "Add batch delete functionality")

üîß OPTIONAL PARAMETERS:
‚Ä¢ brief: Short summary (1-2 sentences)
‚Ä¢ detailed_suggestion: Technical details, steps to reproduce, proposed solutions
‚Ä¢ priority: low | medium | high | critical (default: medium)
‚Ä¢ suggester_signature: Your identifier (auto-generated if not provided)

üí° USAGE EXAMPLES:
‚Ä¢ Bug Report: {product_name: "Ghost Blog API", title: "404 error on post delete", priority: "high", detailed_suggestion: "DELETE /posts/{id} returns 404 even for valid IDs"}
‚Ä¢ Feature Request: {product_name: "Credentials MCP", title: "Add SSH key generation", brief: "Support for ED25519 SSH key pairs"}
‚Ä¢ Enhancement: {product_name: "Database Tools", title: "Improve error messages", priority: "medium"}

üìã WORKFLOW:
submitted ‚Üí under_review ‚Üí accepted/rejected ‚Üí in_progress ‚Üí completed

üéØ TIP: Be specific with product names and provide technical details for faster resolution.

üìö Documentation: https://github.com/preangelleo/my-credentials-mcp`,
		SubmitSuggestionSchema.shape,
		async ({ product_name, title, brief, detailed_suggestion, priority = 'medium', suggester_signature }) => {
			try {
				// Use direct SQL values instead of parameterized queries to work with the HTTP API wrapper
				const finalSuggesterSignature = suggester_signature || `${props.login}-suggestion-${Date.now()}`;
				const sql = `
					INSERT INTO product_improvement_suggestions 
					(product_name, title, brief, detailed_suggestion, priority, suggester_signature, created_at, updated_at)
					VALUES ('${product_name.replace(/'/g, "''")}', '${title.replace(/'/g, "''")}', ${brief ? `'${brief.replace(/'/g, "''")}'` : 'NULL'}, ${detailed_suggestion ? `'${detailed_suggestion.replace(/'/g, "''")}'` : 'NULL'}, '${priority}', '${finalSuggesterSignature.replace(/'/g, "''")}', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
					RETURNING *
				`;
				
				const result = await callHttpApi('/api/execute', 'POST', {
					sql,
					username: props.login
				});

				if (!result.success) {
					return createErrorResponse(`Failed to submit suggestion: ${result.error}`);
				}

				return {
					content: [
						{
							type: "text",
							text: `**‚úÖ Product Suggestion Submitted Successfully**

**Product:** ${product_name}
**Title:** ${title}
**Priority:** ${priority}
**Status:** submitted
**Suggestion ID:** ${result.data?.[0]?.id || 'Generated'}

${brief ? `**Brief:** ${brief}` : ''}

**Submitted by:** ${props.login} (${props.name})
**Timestamp:** ${result.timestamp}

üéØ **What happens next:**
1. Developer will review your suggestion
2. Status will be updated to: under_review ‚Üí accepted/rejected
3. If accepted: in_progress ‚Üí completed
4. You can check status using \`getProductSuggestions\` tool

üí° **Tip:** Use specific product names like "Ghost Blog Management MCP Server", "My Credentials MCP Server", etc. for better tracking.

üìö **Documentation:** https://github.com/preangelleo/my-credentials-mcp`
						}
					]
				};
			} catch (error) {
				console.error('submitProductSuggestion error:', error);
				return createErrorResponse(`Failed to submit suggestion: ${error instanceof Error ? error.message : String(error)}`);
			}
		}
	);

	// Tool 2: Get Product Suggestions - Available to all authenticated users  
	server.tool(
		"getProductSuggestions",
		`üîç BROWSE PRODUCT SUGGESTIONS
		
Retrieve and filter product improvement suggestions. Perfect for checking status of your submissions or browsing existing requests.

üéõÔ∏è FILTER OPTIONS (all optional):
‚Ä¢ product_name: Partial match (e.g., "Ghost", "Credentials", "MCP")
‚Ä¢ status: submitted | under_review | accepted | in_progress | completed | rejected  
‚Ä¢ priority: low | medium | high | critical
‚Ä¢ limit: Number of results (1-100, default: 10)

üîç SEARCH EXAMPLES:
‚Ä¢ Recent critical issues: {priority: "critical", limit: 5}
‚Ä¢ All Ghost Blog suggestions: {product_name: "Ghost Blog", limit: 20}
‚Ä¢ Completed features: {status: "completed"}
‚Ä¢ Your submissions: {suggester_signature: "your-username"}
‚Ä¢ All recent: {} (no filters = latest 10)

üìä RESPONSE INCLUDES:
‚Ä¢ Suggestion ID, title, product name
‚Ä¢ Current status and priority level  
‚Ä¢ Suggester info and creation date
‚Ä¢ Brief description preview
‚Ä¢ Developer notes (if any)

üí° USAGE TIPS:
- Use partial product names for broader search
- Check status regularly for updates on your submissions
- Filter by priority to see urgent issues
- Use higher limits (50-100) for comprehensive views

üìö Documentation: https://github.com/preangelleo/my-credentials-mcp`,
		GetSuggestionsSchema.shape,
		async ({ product_name, status, priority, limit = 10 }) => {
			try {
				let sql = `
					SELECT id, product_name, title, brief, status, priority, suggester_signature, created_at, updated_at, developer_notes
					FROM product_improvement_suggestions
				`;
				const conditions: string[] = [];

				if (product_name) {
					conditions.push(`product_name ILIKE '%${product_name.replace(/'/g, "''")}%'`);
				}

				if (status) {
					conditions.push(`status = '${status}'`);
				}

				if (priority) {
					conditions.push(`priority = '${priority}'`);
				}

				if (conditions.length > 0) {
					sql += ` WHERE ` + conditions.join(' AND ');
				}

				sql += ` ORDER BY created_at DESC LIMIT ${limit}`;

				const result = await callHttpApi('/api/query', 'POST', {
					sql,
					username: props.login
				});

				if (!result.success) {
					return createErrorResponse(`Failed to get suggestions: ${result.error}`);
				}

				const suggestions = result.data || [];
				const filterText = [
					product_name ? `Product: ${product_name}` : '',
					status ? `Status: ${status}` : '',
					priority ? `Priority: ${priority}` : ''
				].filter(Boolean).join(', ') || 'None';

				return {
					content: [
						{
							type: "text",
							text: `**üìã Product Improvement Suggestions**

**Filters Applied:** ${filterText}
**Results Found:** ${suggestions.length}
**Query Time:** ${result.duration}

${suggestions.length === 0 ? 'üìù **No suggestions found with current filters.**' : 
suggestions.map((s: any, i: number) => `
**${i + 1}. [ID: ${s.id}] ${s.title}**
üì¶ **Product:** ${s.product_name}
üìä **Status:** ${s.status} | **Priority:** ${s.priority}
üë§ **Suggester:** ${s.suggester_signature}
üìÖ **Created:** ${new Date(s.created_at).toLocaleDateString()}
${s.brief ? `üí≠ **Brief:** ${s.brief.substring(0, 150)}${s.brief.length > 150 ? '...' : ''}` : ''}
${s.developer_notes ? `üîß **Developer Notes:** ${s.developer_notes.substring(0, 100)}${s.developer_notes.length > 100 ? '...' : ''}` : ''}
---`).join('\n')}

üí° **Available Tools:**
- \`submitProductSuggestion\` - Submit new suggestions
- \`updateSuggestionStatus\` - Update status (developers only)

üîç **Filter Options:** product_name, status (submitted/under_review/accepted/in_progress/completed/rejected), priority (low/medium/high/critical)

üìö **Documentation:** https://github.com/preangelleo/my-credentials-mcp`
						}
					]
				};
			} catch (error) {
				console.error('getProductSuggestions error:', error);
				return createErrorResponse(`Failed to get suggestions: ${error instanceof Error ? error.message : String(error)}`);
			}
		}
	);

	// Tool 3: Update Suggestion Status - Only available to privileged users
	if (PRIVILEGED_USERS.has(props.login)) {
		server.tool(
			"updateSuggestionStatus",
			`‚ö†Ô∏è DEVELOPER STATUS UPDATES (RESTRICTED ACCESS)
			
Update suggestion status and add developer notes. **RESTRICTED to authorized developers only (preangelleo).**

üìä REQUIRED PARAMETERS:
‚Ä¢ id: Suggestion ID (number from getProductSuggestions)
‚Ä¢ status: submitted | under_review | accepted | in_progress | completed | rejected

üîß OPTIONAL PARAMETERS:  
‚Ä¢ developer_notes: Technical notes, implementation details, resolution info
‚Ä¢ priority: Change priority level (low | medium | high | critical)

üí° STATUS WORKFLOW:
submitted ‚Üí under_review ‚Üí accepted ‚Üí in_progress ‚Üí completed
                      ‚Üò rejected

üî• USAGE EXAMPLES:
‚Ä¢ Accept suggestion: {id: 5, status: "accepted", developer_notes: "Good idea, will implement in v2.1", priority: "high"}
‚Ä¢ Mark completed: {id: 8, status: "completed", developer_notes: "Fixed in commit abc123 - deployed to production"}  
‚Ä¢ Reject with reason: {id: 12, status: "rejected", developer_notes: "Conflicts with security policy - cannot implement"}
‚Ä¢ Update progress: {id: 15, status: "in_progress", developer_notes: "50% complete - API changes done, testing UI"}

üìã DEVELOPER RESPONSIBILITIES:
- Provide clear, technical developer_notes for transparency
- Update priority if reassessing importance  
- Move through workflow stages systematically
- Document implementation details and commit references

üéØ BEST PRACTICES:
1. Always add meaningful developer_notes when changing status
2. Reference specific commits, PRs, or version numbers
3. Explain rejection reasons clearly for future reference
4. Update priority based on technical assessment

üìö Documentation: https://github.com/preangelleo/my-credentials-mcp`,
			UpdateSuggestionStatusSchema.shape,
			async ({ id, status, developer_notes, priority }) => {
				try {
					let sql = `
						UPDATE product_improvement_suggestions 
						SET status = '${status}', updated_at = CURRENT_TIMESTAMP
					`;

					if (developer_notes) {
						sql += `, developer_notes = '${developer_notes.replace(/'/g, "''")}'`;
					}

					if (priority) {
						sql += `, priority = '${priority}'`;
					}

					sql += ` WHERE id = ${id} RETURNING *`;

					const result = await callHttpApi('/api/execute', 'POST', {
						sql,
						username: props.login
					});

					if (!result.success) {
						return createErrorResponse(`Failed to update suggestion: ${result.error}`);
					}

					const updated = result.data?.[0];
					if (!updated) {
						return createErrorResponse(`No suggestion found with ID: ${id}`);
					}

					return {
						content: [
							{
								type: "text",
								text: `**‚úÖ Suggestion Status Updated Successfully**

**[ID: ${id}] ${updated.title}**
üì¶ **Product:** ${updated.product_name}
üìä **Status:** ${status} (updated)
${priority ? `üéØ **Priority:** ${priority} (updated)` : `üéØ **Priority:** ${updated.priority}`}
üìÖ **Updated:** ${new Date(updated.updated_at).toLocaleString()}

${developer_notes ? `üîß **Developer Notes Added:**
${developer_notes}` : ''}

**Updated by:** ${props.login} (${props.name})
**Operation time:** ${result.duration}

üìà **Status Workflow:**
submitted ‚Üí under_review ‚Üí accepted/rejected ‚Üí in_progress ‚Üí completed

üìö **Documentation:** https://github.com/preangelleo/my-credentials-mcp`
							}
						]
					};
				} catch (error) {
					console.error('updateSuggestionStatus error:', error);
					return createErrorResponse(`Failed to update suggestion: ${error instanceof Error ? error.message : String(error)}`);
				}
			}
		);
	}

	console.log(`Product feedback tools registered for user: ${props.login} (${props.name})`);
	console.log(`Suggestion submission: Available`);
	console.log(`Status updates: ${PRIVILEGED_USERS.has(props.login) ? 'Available (privileged user)' : 'Not available'}`);
}